<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UsenetStreamer Control Panel</title>
  <link rel="icon" href="/assets/icon.png" type="image/png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <header>
      <h1>UsenetStreamer Control Panel</h1>
      <p class="subtitle">Configure addon credentials, NNTP triage settings, and grab the manifest URL without editing environment files by hand.</p>
      <span class="version-badge hidden" id="addonVersionBadge"></span>
    </header>

    <section class="card">
      <h2>Authentication</h2>
  <p class="hint">Optional security: enter the change token (the value embedded in your manifest) only if you enabled it via configuration. Leave this blank if you never set <code>ADDON_SHARED_SECRET</code>.</p>
      <p class="warning">Treat this token like a password. If someone has both the token and the public addon URL, they can open the admin panel and view or modify your credentials.</p>
      <div class="field-row">
        <label for="tokenInput">Change Token</label>
        <input id="tokenInput" type="password" autocomplete="off" />
      </div>
      <button id="loadConfig" class="primary">Load Configuration</button>
      <p id="authError" class="error hidden"></p>
    </section>

    <section class="card hidden" id="configSection">
      <form id="configForm">
        <section class="group streaming-mode-section">
          <h3>Streaming Mode</h3>
          <p class="hint">Choose how streams are delivered to Stremio. Windows Native mode requires Stremio v5 on Windows desktop.</p>
          <div class="field-grid">
            <label>
              <select name="STREAMING_MODE" id="streamingModeSelect">
                <option value="nzbdav">NZBDav Mode (All Platforms)</option>
                <option value="native">Windows Native Mode (Stremio v5 Desktop)</option>
              </select>
              <span class="field-hint" id="streamingModeHint">NZBDav mode uses WebDAV streaming and works on all platforms. Windows Native mode streams directly via NNTP (experimental, Windows only).</span>
            </label>
          </div>
          <div id="nativeModeNotice" class="info-box hidden">
            <strong>‚ö° Windows Native Mode</strong>
            <p>Streams NZBs directly using your NNTP provider credentials. No NZBDav required. Only works with Stremio v5 on Windows desktop.</p>
            <p>Prowlarr/NZBHydra are disabled in this mode ‚Äî use direct Newznab indexers only.</p>
          </div>
        </section>

        <section class="group" id="indexerManagerGroup">
          <h3>Indexer Manager</h3>
          <div class="field-grid">
            <label>Manager Type
              <select name="INDEXER_MANAGER">
                <option value="prowlarr">Prowlarr</option>
                <option value="nzbhydra">NZBHydra</option>
                <option value="none" selected>Newznab Only (Recommended)</option>
              </select>
            </label>
            <label data-manager-field>Manager URL
              <input name="INDEXER_MANAGER_URL" type="url" placeholder="http://localhost:9696" />
            </label>
            <label data-manager-field>API Key
              <input name="INDEXER_MANAGER_API_KEY" type="password" autocomplete="new-password" />
            </label>
            <label data-manager-field>Indexer IDs / Names
              <input name="INDEXER_MANAGER_INDEXERS" type="text" placeholder="-1 or sci-fi,4k" />
              <span class="field-hint">Comma-separated list of indexers this addon may query. Prowlarr: numeric IDs, with -1 meaning ‚Äúall Usenet indexers‚Äù. NZBHydra: type the indexer names exactly as shown in Hydra.</span>
            </label>
            <label data-manager-field>Paid Indexers (comma separated)
              <input name="NZB_TRIAGE_PRIORITY_INDEXERS" type="text" placeholder="9,33" />
              <span class="field-hint">Subset of the above list that gets used for health checks. Must be a comma-separated subset of ‚ÄúIndexer IDs / Names‚Äù.</span>
            </label>
            <label class="checkbox">
              <input name="INDEXER_MANAGER_STRICT_ID_MATCH" type="checkbox" />
              <span>Strict ID Matching Only</span>
              <span class="field-hint">Applies to both manager and direct Newznab searches. ID-only mode skips text queries.</span>
            </label>
          </div>
          <div class="inline-actions" data-manager-field>
            <button type="button" class="secondary" data-test="indexer">Test Connection</button>
            <span class="status-message" data-test-status="indexer"></span>
          </div>
        </section>

        <section class="group" id="newznabGroup">
          <h3>Direct Newznab Indexers (Optional)</h3>
          <p class="hint">Add one or more direct Newznab endpoints. Enable them to search alongside your manager (or run manager-free), test each row, and reorder to control priority.</p>
          <div class="newznab-preset-bar">
            <label>Preset
              <select id="newznabPreset"></select>
            </label>
            <button type="button" id="addPresetIndexer" class="secondary">Add from preset</button>
          </div>
          <div id="newznab-indexers-list" class="newznab-list">
            <p class="newznab-empty-hint" data-empty-hint>No indexers added yet. Pick a preset or add one manually.</p>
          </div>
          <div class="newznab-actions-top">
            <button type="button" id="addNewznabIndexer" class="secondary">Add Indexer</button>
          </div>
          <div class="divider"></div>
          <div class="newznab-controls">
            <label class="checkbox">
              <input name="NEWZNAB_FILTER_NZB_ONLY" type="checkbox" checked />
              <span>Filter to NZB URLs Only</span>
              <span class="field-hint">Keeps only download links ending with .nzb or getnzb (recommended to reduce noise).</span>
            </label>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-test="newznab">Test Connection</button>
            <span class="status-message" data-test-status="newznab"></span>
          </div>
          <div id="newznab-test-search" class="hidden">
            <div class="field-grid">
              <label>Test Search Type
                <select name="NEWZNAB_TEST_TYPE">
                  <option value="search">General</option>
                  <option value="movie">Movie</option>
                  <option value="tvsearch">TV</option>
                </select>
              </label>
              <label>Test Search Query
                <input name="NEWZNAB_TEST_QUERY" type="text" placeholder="e.g. Dune 2021 1080p" />
                <span class="field-hint">Runs a Newznab search against the configured endpoints and shows a quick summary.</span>
              </label>
            </div>
            <div class="inline-actions">
              <button type="button" class="secondary" data-test="newznab-search">Run Test Search</button>
              <span class="status-message" data-test-status="newznab-search"></span>
            </div>
          </div>
        </section>

        <section class="group">
          <h3>Built-in Easynews Indexer</h3>
          <p class="hint">Provide your Easynews credentials to let the addon search Easynews directly (no external bridge required). Only the username and password are needed.</p>
          <div class="field-grid">
            <label class="checkbox">
              <input name="EASYNEWS_ENABLED" type="checkbox" />
              <span>Enable Easynews Integration</span>
              <span class="field-hint">Adds Easynews as a first-class indexer. Results skip health checks, so NZBDav queues them immediately.</span>
            </label>
            <label>Easynews Username
              <input name="EASYNEWS_USERNAME" type="text" autocomplete="username" />
            </label>
            <label>Easynews Password
              <input name="EASYNEWS_PASSWORD" type="password" autocomplete="current-password" />
            </label>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-test="easynews">Test Easynews Login</button>
            <span class="status-message" data-test-status="easynews"></span>
          </div>
        </section>

        <section class="group">
          <h3>Result Sorting &amp; Filters</h3>
          <div class="field-grid">
            <label>Sorting Mode
              <select name="NZB_SORT_MODE">
                <option value="quality_then_size">Quality ‚Üí Size</option>
                <option value="language_quality_size">Preferred Language ‚Üí Quality ‚Üí Size</option>
              </select>
              <span class="field-hint">Choose how releases are prioritized before NZB health checks run.</span>
            </label>
            <div class="language-multiselect wide-field" data-language-selector>
              <span class="field-label">Preferred Languages</span>
              <input type="hidden" name="NZB_PREFERRED_LANGUAGE" data-language-hidden />
              <div class="language-checkbox-grid">
                <label class="checkbox"><input type="checkbox" value="English" data-language-option /> <span>English</span></label>
                <label class="checkbox"><input type="checkbox" value="Tamil" data-language-option /> <span>Tamil</span></label>
                <label class="checkbox"><input type="checkbox" value="Hindi" data-language-option /> <span>Hindi</span></label>
                <label class="checkbox"><input type="checkbox" value="Malayalam" data-language-option /> <span>Malayalam</span></label>
                <label class="checkbox"><input type="checkbox" value="Kannada" data-language-option /> <span>Kannada</span></label>
                <label class="checkbox"><input type="checkbox" value="Telugu" data-language-option /> <span>Telugu</span></label>
                <label class="checkbox"><input type="checkbox" value="Chinese" data-language-option /> <span>Chinese</span></label>
                <label class="checkbox"><input type="checkbox" value="Russian" data-language-option /> <span>Russian</span></label>
                <label class="checkbox"><input type="checkbox" value="Arabic" data-language-option /> <span>Arabic</span></label>
                <label class="checkbox"><input type="checkbox" value="Japanese" data-language-option /> <span>Japanese</span></label>
                <label class="checkbox"><input type="checkbox" value="Korean" data-language-option /> <span>Korean</span></label>
                <label class="checkbox"><input type="checkbox" value="Taiwanese" data-language-option /> <span>Taiwanese</span></label>
                <label class="checkbox"><input type="checkbox" value="Latino" data-language-option /> <span>Latino</span></label>
                <label class="checkbox"><input type="checkbox" value="French" data-language-option /> <span>French</span></label>
                <label class="checkbox"><input type="checkbox" value="Spanish" data-language-option /> <span>Spanish</span></label>
                <label class="checkbox"><input type="checkbox" value="Portuguese" data-language-option /> <span>Portuguese</span></label>
                <label class="checkbox"><input type="checkbox" value="Italian" data-language-option /> <span>Italian</span></label>
                <label class="checkbox"><input type="checkbox" value="German" data-language-option /> <span>German</span></label>
                <label class="checkbox"><input type="checkbox" value="Ukrainian" data-language-option /> <span>Ukrainian</span></label>
                <label class="checkbox"><input type="checkbox" value="Polish" data-language-option /> <span>Polish</span></label>
                <label class="checkbox"><input type="checkbox" value="Czech" data-language-option /> <span>Czech</span></label>
                <label class="checkbox"><input type="checkbox" value="Thai" data-language-option /> <span>Thai</span></label>
                <label class="checkbox"><input type="checkbox" value="Indonesian" data-language-option /> <span>Indonesian</span></label>
                <label class="checkbox"><input type="checkbox" value="Vietnamese" data-language-option /> <span>Vietnamese</span></label>
                <label class="checkbox"><input type="checkbox" value="Dutch" data-language-option /> <span>Dutch</span></label>
                <label class="checkbox"><input type="checkbox" value="Bengali" data-language-option /> <span>Bengali</span></label>
                <label class="checkbox"><input type="checkbox" value="Turkish" data-language-option /> <span>Turkish</span></label>
                <label class="checkbox"><input type="checkbox" value="Greek" data-language-option /> <span>Greek</span></label>
                <label class="checkbox"><input type="checkbox" value="Swedish" data-language-option /> <span>Swedish</span></label>
                <label class="checkbox"><input type="checkbox" value="Romanian" data-language-option /> <span>Romanian</span></label>
                <label class="checkbox"><input type="checkbox" value="Hungarian" data-language-option /> <span>Hungarian</span></label>
                <label class="checkbox"><input type="checkbox" value="Finnish" data-language-option /> <span>Finnish</span></label>
                <label class="checkbox"><input type="checkbox" value="Norwegian" data-language-option /> <span>Norwegian</span></label>
                <label class="checkbox"><input type="checkbox" value="Danish" data-language-option /> <span>Danish</span></label>
                <label class="checkbox"><input type="checkbox" value="Hebrew" data-language-option /> <span>Hebrew</span></label>
                <label class="checkbox"><input type="checkbox" value="Lithuanian" data-language-option /> <span>Lithuanian</span></label>
                <label class="checkbox"><input type="checkbox" value="Punjabi" data-language-option /> <span>Punjabi</span></label>
                <label class="checkbox"><input type="checkbox" value="Marathi" data-language-option /> <span>Marathi</span></label>
                <label class="checkbox"><input type="checkbox" value="Gujarati" data-language-option /> <span>Gujarati</span></label>
                <label class="checkbox"><input type="checkbox" value="Bhojpuri" data-language-option /> <span>Bhojpuri</span></label>
                <label class="checkbox"><input type="checkbox" value="Nepali" data-language-option /> <span>Nepali</span></label>
                <label class="checkbox"><input type="checkbox" value="Urdu" data-language-option /> <span>Urdu</span></label>
                <label class="checkbox"><input type="checkbox" value="Tagalog" data-language-option /> <span>Tagalog</span></label>
                <label class="checkbox"><input type="checkbox" value="Filipino" data-language-option /> <span>Filipino</span></label>
                <label class="checkbox"><input type="checkbox" value="Malay" data-language-option /> <span>Malay</span></label>
                <label class="checkbox"><input type="checkbox" value="Mongolian" data-language-option /> <span>Mongolian</span></label>
                <label class="checkbox"><input type="checkbox" value="Armenian" data-language-option /> <span>Armenian</span></label>
                <label class="checkbox"><input type="checkbox" value="Georgian" data-language-option /> <span>Georgian</span></label>
              </div>
            </div>
            <label>Max File Size (GB)
              <input name="NZB_MAX_RESULT_SIZE_GB" type="number" min="0" step="0.1" placeholder="30" />
              <span class="field-hint">Defaults to 30 GB. Set 0 for no cap; larger releases are skipped before health checks.</span>
            </label>
            <label class="checkbox">
              <input name="NZB_DEDUP_ENABLED" type="checkbox" checked />
              <span>
                Hide duplicate releases
                <span class="field-hint">Collapses identical matches (same title/indexer/size). Disable to inspect every result.</span>
              </span>
            </label>
            <label class="checkbox">
              <input name="NZB_HIDE_BLOCKED_RESULTS" type="checkbox" />
              <span>
                Hide blocked NZBs
                <span class="field-hint">Blocked releases already show a red üö´ tag; enable this to remove them entirely from manifests.</span>
              </span>
            </label>
          </div>
          <div class="quality-filter">
            <div class="quality-filter-header">
              <span>Quality Filters</span>
              <span class="field-hint">Uncheck resolutions you do not want to display. Filtering happens before NZB health checks.</span>
            </div>
            <div class="quality-checkbox-grid">
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="4320p" checked />
                <span>4320p / 8K</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="2160p" checked />
                <span>2160p / 4K / UHD</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="1440p" checked />
                <span>1440p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="1080p" checked />
                <span>1080p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="720p" checked />
                <span>720p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="576p" checked />
                <span>576p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="540p" checked />
                <span>540p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="480p" checked />
                <span>480p / SD</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="360p" checked />
                <span>360p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="240p" checked />
                <span>240p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="unknown" checked />
                <span>Unknown / Not Tagged</span>
              </label>
            </div>
            <input type="hidden" name="NZB_ALLOWED_RESOLUTIONS" value="" />
            <label>Streams per Quality (optional)
              <input name="NZB_RESOLUTION_LIMIT_PER_QUALITY" type="number" min="0" placeholder="Unlimited" />
              <span class="field-hint">Applies evenly to every enabled resolution. Leave blank or set 0 for no cap.</span>
            </label>
          </div>
        </section>

        <section class="group" id="nzbdavGroup">
          <h3>NZBDav Connection</h3>
          <div class="field-grid">
            <label>NZBDav URL
              <input name="NZBDAV_URL" type="url" placeholder="http://localhost:3000" />
            </label>
            <label>NZBDav API Key
              <input name="NZBDAV_API_KEY" type="password" autocomplete="new-password" />
            </label>
            <label>WebDAV URL
              <input name="NZBDAV_WEBDAV_URL" type="url" placeholder="http://localhost:3000" />
            </label>
            <label>WebDAV User
              <input name="NZBDAV_WEBDAV_USER" type="text" />
            </label>
            <label>WebDAV Password
              <input name="NZBDAV_WEBDAV_PASS" type="password" autocomplete="new-password" />
            </label>
            <label>Base Category
              <input name="NZBDAV_CATEGORY" type="text" placeholder="Stremio" />
            </label>
            <label>Movies Category
              <input name="NZBDAV_CATEGORY_MOVIES" type="text" placeholder="Movies" />
            </label>
            <label>Series Category
              <input name="NZBDAV_CATEGORY_SERIES" type="text" placeholder="Tv" />
            </label>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-test="nzbdav">Test Connection</button>
            <span class="status-message" data-test-status="nzbdav"></span>
          </div>
        </section>

        <section class="group">
          <h3>NZB Health Check</h3>
          <div class="field-grid">
            <label class="checkbox">
              <input name="NZB_TRIAGE_ENABLED" type="checkbox" />
              <span>Enable NZB Health Checks</span>
            </label>
            <p class="warning hidden" id="healthPaidWarning">Mark at least one indexer as paid (manager list or direct Newznab) before running health checks.</p>
            <label>Usenet Provider Host
              <input name="NZB_TRIAGE_NNTP_HOST" type="text" placeholder="news.easynews.com" data-health-required="true" />
            </label>
            <label>Usenet Provider Port
              <input name="NZB_TRIAGE_NNTP_PORT" type="number" min="1" placeholder="563" data-health-required="true" />
            </label>
            <label class="checkbox">
              <input name="NZB_TRIAGE_NNTP_TLS" type="checkbox" />
              <span>Use TLS</span>
            </label>
            <label>Usenet Provider Username
              <input name="NZB_TRIAGE_NNTP_USER" type="text" autocomplete="off" data-health-required="true" />
            </label>
            <label>Usenet Provider Password
              <input name="NZB_TRIAGE_NNTP_PASS" type="password" autocomplete="new-password" data-health-required="true" />
            </label>
            <label>Number of NZBs to Inspect
              <select name="NZB_TRIAGE_MAX_CANDIDATES" data-health-required="true">
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="6">6</option>
              </select>
              <span class="field-hint">Pick 2 for the fastest responses, 4 or 6 to probe more candidates.</span>
            </label>
            <label>Max Usenet Connections
              <input name="NZB_TRIAGE_MAX_CONNECTIONS" type="number" min="1" step="1" data-health-required="true" />
              <span class="field-hint">Keep this ‚â§ 2 √ó ‚ÄúNumber of NZBs to Inspect‚Äù, and ensure the combined total of these connections plus any NZBDav connections stays within your provider‚Äôs max.</span>
            </label>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-test="usenet">Test Connection</button>
            <span class="status-message" data-test-status="usenet"></span>
          </div>
        </section>

        <section class="group">
          <h3>Addon Metadata</h3>
          <div class="field-grid">
            <label>Addon Display Name
              <input name="ADDON_NAME" type="text" placeholder="UsenetStreamer" />
              <span class="field-hint">Appears in Stremio as the addon title.</span>
            </label>
            <label>Public Base URL
              <input name="ADDON_BASE_URL" type="url" placeholder="https://example.com" />
            </label>
            <label>Change Token
              <input name="ADDON_SHARED_SECRET" type="password" autocomplete="new-password" />
              <span class="field-hint">Optional ‚Äî set this only when you want the manifest, streams, and admin API protected by a shared secret.</span>
            </label>
          </div>
        </section>

        <div class="actions">
          <button type="submit" class="primary">Save Changes</button>
          <span id="saveStatus" class="status-message"></span>
          <p id="sourceGuardNotice" class="warning hidden">
            Select a manager, enable Easynews, or turn on at least one direct Newznab indexer before saving.
          </p>
        </div>
      </form>

      <div class="manifest-row">
        <div class="manifest-info">
          <strong>Manifest URL</strong>
          <p id="manifestDescription" class="hint">Use the buttons to copy or install the addon once HTTPS and your token are set.</p>
        </div>
        <div class="manifest-actions">
          <button type="button" class="secondary" id="installStremioWeb" disabled>Install via Stremio Web</button>
          <button type="button" class="secondary" id="installStremioApp" disabled>Open in Stremio App</button>
          <button type="button" class="secondary" id="copyManifest" disabled>Copy Manifest URL</button>
          <span id="copyManifestStatus" class="copy-status" aria-live="polite"></span>
        </div>
      </div>

      <p class="support-note">If you like this addon, please consider <a href="https://buymeacoffee.com/gaikwadsank" target="_blank" rel="noopener">buying me a coffee</a>.</p>
    </section>
  </main>
  <script src="app.js"></script>
</body>
</html>
