<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UsenetStreamer Control Panel</title>
  <link rel="icon" href="/assets/icon.png" type="image/png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <header>
      <h1>UsenetStreamer Control Panel</h1>
      <p class="subtitle">Configure addon credentials, NNTP triage settings, and grab the manifest URL without editing environment files by hand.</p>
    </header>

    <section class="card">
      <h2>Authentication</h2>
  <p class="hint">Optional security: enter the change token (the value embedded in your manifest) only if you enabled it via configuration. Leave this blank if you never set <code>ADDON_SHARED_SECRET</code>.</p>
      <p class="warning">Treat this token like a password. If someone has both the token and the public addon URL, they can open the admin panel and view or modify your credentials.</p>
      <div class="field-row">
        <label for="tokenInput">Change Token</label>
        <input id="tokenInput" type="password" autocomplete="off" />
      </div>
      <button id="loadConfig" class="primary">Load Configuration</button>
      <p id="authError" class="error hidden"></p>
    </section>

    <section class="card hidden" id="configSection">
      <form id="configForm">
        <section class="group">
          <h3>Indexer Manager</h3>
          <div class="field-grid">
            <label>Manager Type
              <select name="INDEXER_MANAGER">
                <option value="prowlarr">Prowlarr</option>
                <option value="nzbhydra">NZBHydra</option>
                <option value="none" selected>Newznab Only (Recommended)</option>
              </select>
            </label>
            <label data-manager-field>Manager URL
              <input name="INDEXER_MANAGER_URL" type="url" placeholder="http://localhost:9696" />
            </label>
            <label data-manager-field>API Key
              <input name="INDEXER_MANAGER_API_KEY" type="password" autocomplete="new-password" />
            </label>
            <label data-manager-field>Indexer IDs / Names
              <input name="INDEXER_MANAGER_INDEXERS" type="text" placeholder="-1 or sci-fi,4k" />
              <span class="field-hint">Comma-separated list of indexers this addon may query. Prowlarr: numeric IDs, with -1 meaning “all Usenet indexers”. NZBHydra: type the indexer names exactly as shown in Hydra.</span>
            </label>
            <label data-manager-field>Paid Indexers (comma separated)
              <input name="NZB_TRIAGE_PRIORITY_INDEXERS" type="text" placeholder="9,33" />
              <span class="field-hint">Subset of the above list that gets used for health checks. Must be a comma-separated subset of “Indexer IDs / Names”.</span>
            </label>
            <label class="checkbox">
              <input name="INDEXER_MANAGER_STRICT_ID_MATCH" type="checkbox" />
              <span>Strict ID Matching Only</span>
              <span class="field-hint">Applies to both manager and direct Newznab searches. ID-only mode skips text queries.</span>
            </label>
          </div>
          <div class="inline-actions" data-manager-field>
            <button type="button" class="secondary" data-test="indexer">Test Connection</button>
            <span class="status-message" data-test-status="indexer"></span>
          </div>
        </section>

        <section class="group" id="newznabGroup">
          <h3>Direct Newznab Indexers (Optional)</h3>
          <p class="hint">Add one or more direct Newznab endpoints. Enable them to search alongside your manager (or run manager-free), test each row, and reorder to control priority.</p>
          <div class="newznab-preset-bar">
            <label>Preset
              <select id="newznabPreset"></select>
            </label>
            <button type="button" id="addPresetIndexer" class="secondary">Add from preset</button>
          </div>
          <div id="newznab-indexers-list" class="newznab-list">
            <p class="newznab-empty-hint" data-empty-hint>No indexers added yet. Pick a preset or add one manually.</p>
          </div>
          <div class="newznab-actions-top">
            <button type="button" id="addNewznabIndexer" class="secondary">Add Indexer</button>
          </div>
          <div class="divider"></div>
          <div class="newznab-controls">
            <label class="checkbox">
              <input name="NEWZNAB_FILTER_NZB_ONLY" type="checkbox" checked />
              <span>Filter to NZB URLs Only</span>
              <span class="field-hint">Keeps only download links ending with .nzb or getnzb (recommended to reduce noise).</span>
            </label>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-test="newznab">Test Connection</button>
            <span class="status-message" data-test-status="newznab"></span>
          </div>
          <div id="newznab-test-search" class="hidden">
            <div class="field-grid">
              <label>Test Search Type
                <select name="NEWZNAB_TEST_TYPE">
                  <option value="search">General</option>
                  <option value="movie">Movie</option>
                  <option value="tvsearch">TV</option>
                </select>
              </label>
              <label>Test Search Query
                <input name="NEWZNAB_TEST_QUERY" type="text" placeholder="e.g. Dune 2021 1080p" />
                <span class="field-hint">Runs a Newznab search against the configured endpoints and shows a quick summary.</span>
              </label>
            </div>
            <div class="inline-actions">
              <button type="button" class="secondary" data-test="newznab-search">Run Test Search</button>
              <span class="status-message" data-test-status="newznab-search"></span>
            </div>
          </div>
        </section>

        <section class="group">
          <h3>Result Sorting &amp; Filters</h3>
          <div class="field-grid">
            <label>Sorting Mode
              <select name="NZB_SORT_MODE">
                <option value="quality_then_size">Quality → Size</option>
                <option value="language_quality_size">Preferred Language → Quality → Size</option>
              </select>
              <span class="field-hint">Choose how releases are prioritized before NZB health checks run.</span>
            </label>
            <label>Preferred Language
              <select name="NZB_PREFERRED_LANGUAGE" data-sorting-language>
                <option value="">No preference</option>
                <option value="English">English</option>
                <option value="Tamil">Tamil</option>
                <option value="Hindi">Hindi</option>
                <option value="Malayalam">Malayalam</option>
                <option value="Kannada">Kannada</option>
                <option value="Telugu">Telugu</option>
                <option value="Chinese">Chinese</option>
                <option value="Russian">Russian</option>
                <option value="Arabic">Arabic</option>
                <option value="Japanese">Japanese</option>
                <option value="Korean">Korean</option>
                <option value="Taiwanese">Taiwanese</option>
                <option value="Latino">Latino</option>
                <option value="French">French</option>
                <option value="Spanish">Spanish</option>
                <option value="Portuguese">Portuguese</option>
                <option value="Italian">Italian</option>
                <option value="German">German</option>
                <option value="Ukrainian">Ukrainian</option>
                <option value="Polish">Polish</option>
                <option value="Czech">Czech</option>
                <option value="Thai">Thai</option>
                <option value="Indonesian">Indonesian</option>
                <option value="Vietnamese">Vietnamese</option>
                <option value="Dutch">Dutch</option>
                <option value="Bengali">Bengali</option>
                <option value="Turkish">Turkish</option>
                <option value="Greek">Greek</option>
                <option value="Swedish">Swedish</option>
                <option value="Romanian">Romanian</option>
                <option value="Hungarian">Hungarian</option>
                <option value="Finnish">Finnish</option>
                <option value="Norwegian">Norwegian</option>
                <option value="Danish">Danish</option>
                <option value="Hebrew">Hebrew</option>
                <option value="Lithuanian">Lithuanian</option>
                <option value="Punjabi">Punjabi</option>
                <option value="Marathi">Marathi</option>
                <option value="Gujarati">Gujarati</option>
                <option value="Bhojpuri">Bhojpuri</option>
                <option value="Nepali">Nepali</option>
                <option value="Urdu">Urdu</option>
                <option value="Tagalog">Tagalog</option>
                <option value="Filipino">Filipino</option>
                <option value="Malay">Malay</option>
                <option value="Mongolian">Mongolian</option>
                <option value="Armenian">Armenian</option>
                <option value="Georgian">Georgian</option>
              </select>
              <span class="field-hint">Required only when using the language-first sorting mode.</span>
            </label>
            <label>Max File Size (GB)
              <input name="NZB_MAX_RESULT_SIZE_GB" type="number" min="0" step="0.1" placeholder="30" />
              <span class="field-hint">Defaults to 30 GB. Set 0 for no cap; larger releases are skipped before health checks.</span>
            </label>
          </div>
          <div class="quality-filter">
            <div class="quality-filter-header">
              <span>Quality Filters</span>
              <span class="field-hint">Uncheck resolutions you do not want to display. Filtering happens before NZB health checks.</span>
            </div>
            <div class="quality-checkbox-grid">
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="4320p" checked />
                <span>4320p / 8K</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="2160p" checked />
                <span>2160p / 4K / UHD</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="1440p" checked />
                <span>1440p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="1080p" checked />
                <span>1080p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="720p" checked />
                <span>720p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="576p" checked />
                <span>576p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="540p" checked />
                <span>540p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="480p" checked />
                <span>480p / SD</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="360p" checked />
                <span>360p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="240p" checked />
                <span>240p</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" data-quality-option value="unknown" checked />
                <span>Unknown / Not Tagged</span>
              </label>
            </div>
            <input type="hidden" name="NZB_ALLOWED_RESOLUTIONS" value="" />
          </div>
        </section>

        <section class="group">
          <h3>NZBDav Connection</h3>
          <div class="field-grid">
            <label>NZBDav URL
              <input name="NZBDAV_URL" type="url" placeholder="http://localhost:3000" />
            </label>
            <label>NZBDav API Key
              <input name="NZBDAV_API_KEY" type="password" autocomplete="new-password" />
            </label>
            <label>WebDAV URL
              <input name="NZBDAV_WEBDAV_URL" type="url" placeholder="http://localhost:3000" />
            </label>
            <label>WebDAV User
              <input name="NZBDAV_WEBDAV_USER" type="text" />
            </label>
            <label>WebDAV Password
              <input name="NZBDAV_WEBDAV_PASS" type="password" autocomplete="new-password" />
            </label>
            <label>Base Category
              <input name="NZBDAV_CATEGORY" type="text" placeholder="Stremio" />
            </label>
            <label>Movies Category
              <input name="NZBDAV_CATEGORY_MOVIES" type="text" placeholder="Movies" />
            </label>
            <label>Series Category
              <input name="NZBDAV_CATEGORY_SERIES" type="text" placeholder="Tv" />
            </label>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-test="nzbdav">Test Connection</button>
            <span class="status-message" data-test-status="nzbdav"></span>
          </div>
        </section>

        <section class="group">
          <h3>NZB Health Check</h3>
          <div class="field-grid">
            <label class="checkbox">
              <input name="NZB_TRIAGE_ENABLED" type="checkbox" />
              <span>Enable NZB Health Checks</span>
            </label>
            <p class="warning hidden" id="healthPaidWarning">Mark at least one indexer as paid (manager list or direct Newznab) before running health checks.</p>
            <label>Usenet Provider Host
              <input name="NZB_TRIAGE_NNTP_HOST" type="text" placeholder="news.easynews.com" data-health-required="true" />
            </label>
            <label>Usenet Provider Port
              <input name="NZB_TRIAGE_NNTP_PORT" type="number" min="1" placeholder="563" data-health-required="true" />
            </label>
            <label class="checkbox">
              <input name="NZB_TRIAGE_NNTP_TLS" type="checkbox" />
              <span>Use TLS</span>
            </label>
            <label>Usenet Provider Username
              <input name="NZB_TRIAGE_NNTP_USER" type="text" autocomplete="off" data-health-required="true" />
            </label>
            <label>Usenet Provider Password
              <input name="NZB_TRIAGE_NNTP_PASS" type="password" autocomplete="new-password" data-health-required="true" />
            </label>
            <label>Number of NZBs to Inspect
              <select name="NZB_TRIAGE_MAX_CANDIDATES" data-health-required="true">
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="6">6</option>
              </select>
              <span class="field-hint">Pick 2 for the fastest responses, 4 or 6 to probe more candidates.</span>
            </label>
            <label>Max Usenet Connections
              <input name="NZB_TRIAGE_MAX_CONNECTIONS" type="number" min="1" step="1" data-health-required="true" />
              <span class="field-hint">Keep this ≤ 2 × “Number of NZBs to Inspect”, and ensure the combined total of these connections plus any NZBDav connections stays within your provider’s max.</span>
            </label>
          </div>
          <div class="inline-actions">
            <button type="button" class="secondary" data-test="usenet">Test Connection</button>
            <span class="status-message" data-test-status="usenet"></span>
          </div>
        </section>

        <section class="group">
          <h3>Addon Metadata</h3>
          <div class="field-grid">
            <label>Addon Display Name
              <input name="ADDON_NAME" type="text" placeholder="UsenetStreamer" />
              <span class="field-hint">Appears in Stremio as the addon title.</span>
            </label>
            <label>Public Base URL
              <input name="ADDON_BASE_URL" type="url" placeholder="https://example.com" />
            </label>
            <label>Change Token
              <input name="ADDON_SHARED_SECRET" type="password" autocomplete="new-password" />
              <span class="field-hint">Optional — set this only when you want the manifest, streams, and admin API protected by a shared secret.</span>
            </label>
          </div>
        </section>

        <div class="actions">
          <button type="submit" class="primary">Save Changes</button>
          <span id="saveStatus" class="status-message"></span>
          <p id="sourceGuardNotice" class="warning hidden">
            Select a manager or enable at least one direct Newznab indexer before saving.
          </p>
        </div>
      </form>

      <div class="manifest-row">
        <div class="manifest-info">
          <strong>Manifest URL</strong>
          <p id="manifestDescription" class="hint">Use the buttons to copy or install the addon once HTTPS and your token are set.</p>
        </div>
        <div class="manifest-actions">
          <button type="button" class="secondary" id="installStremioWeb" disabled>Install via Stremio Web</button>
          <button type="button" class="secondary" id="installStremioApp" disabled>Open in Stremio App</button>
          <button type="button" class="secondary" id="copyManifest" disabled>Copy Manifest URL</button>
          <span id="copyManifestStatus" class="copy-status" aria-live="polite"></span>
        </div>
      </div>

      <p class="support-note">If you like this addon, please consider <a href="https://buymeacoffee.com/gaikwadsank" target="_blank" rel="noopener">buying me a coffee</a>.</p>
    </section>
  </main>
  <script src="app.js"></script>
</body>
</html>
